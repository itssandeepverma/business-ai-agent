<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Business Agent</title>
    <!-- Beautiful UI Library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .log-line {
            border-left: 2px solid #6366f1;
            padding-left: 12px;
            margin-bottom: 6px;
        }

        .tab-content.hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- üè¢ LOGO & TITLE -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-black text-indigo-600 tracking-tighter">BUSINESS AI AGENT</h1>
            <p class="text-slate-500 mt-2 text-lg font-medium">Plan Business Like a PRO</p>
        </header>

        <!-- üìù CONFIGURATION & INPUT SECTION -->
        <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 mb-10">
            <form id="agentForm" class="space-y-6">
                <!-- 1. Task Input -->
                <div>
                    <label class="block text-sm font-black text-slate-700 mb-2 uppercase tracking-widest">Business
                        Goal</label>
                    <textarea id="taskInput" rows="3"
                        class="w-full px-6 py-4 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition-all outline-none text-lg"
                        placeholder="e.g. Create a strategy to launch a new coffee brand in Austin..."></textarea>
                </div>

                <!-- 2. Advanced Settings (Tone & Depth) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">Voice
                            Tone</label>
                        <select id="toneInput"
                            class="w-full px-5 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white outline-none transition-all">
                            <option value="professional">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="premium">Premium (Luxury)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">Analysis
                            Depth</label>
                        <select id="depthInput"
                            class="w-full px-5 py-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white outline-none transition-all">
                            <option value="quick">Quick Plan</option>
                            <option value="normal" selected>Normal</option>
                            <option value="deep">Deep Dive</option>
                        </select>
                    </div>
                </div>

                <!-- 3. Context Upload (RAG) -->
                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-black text-indigo-900 mb-1 uppercase tracking-tight">Add
                                Context (PDF / TXT)</label>
                            <input type="file" id="contextFile" accept=".pdf,.txt"
                                class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 transition-all">
                        </div>
                        <button type="button" id="clearContextBtn"
                            class="text-xs font-bold text-rose-500 hover:text-rose-700 underline underline-offset-4 decoration-rose-300">
                            üóëÔ∏è Clear Memory
                        </button>
                    </div>
                </div>

                <!-- Run Button -->
                <button type="submit" id="runBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-5 rounded-2xl transition-all shadow-lg active:scale-95 text-lg uppercase tracking-wider">
                    Analyze & Generate Plan
                </button>
            </form>
        </section>

        <!-- üìü LIVE LOG CONSOLE -->
        <section id="logsSection" class="hidden mb-12">
            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Internal Thought Process</h3>
            <div id="logsContainer"
                class="bg-slate-900 rounded-2xl p-8 font-mono text-sm text-indigo-400 overflow-y-auto max-h-60 shadow-inner border border-slate-800">
                <!-- Logs will appear here dynamically -->
            </div>
        </section>

        <!-- üìä RESULTS SECTION -->
        <section id="resultsSection" class="hidden space-y-10">

            <!-- Navigation Tabs -->
            <div class="flex space-x-2 border-b border-slate-200 overflow-x-auto pb-px">
                <button
                    class="tab-btn px-8 py-4 font-bold text-sm text-indigo-600 border-b-4 border-indigo-600 whitespace-nowrap"
                    data-tab="overview">Strategy</button>
                <button
                    class="tab-btn px-8 py-4 font-bold text-sm text-slate-400 border-b-4 border-transparent hover:text-slate-600 whitespace-nowrap"
                    data-tab="marketing">Marketing</button>
                <button
                    class="tab-btn px-8 py-4 font-bold text-sm text-slate-400 border-b-4 border-transparent hover:text-slate-600 whitespace-nowrap"
                    data-tab="emails">Emails</button>
                <button
                    class="tab-btn px-8 py-4 font-bold text-sm text-slate-400 border-b-4 border-transparent hover:text-slate-600 whitespace-nowrap"
                    data-tab="tasks">Tasks</button>
            </div>

            <!-- TAB 1: Strategy Overview -->
            <div id="overviewTab" class="tab-content">
                <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-black text-slate-900 mb-6">Strategic Summary</h3>
                    <div id="summaryText" class="text-slate-600 text-lg leading-relaxed mb-8 italic">[Generating...]
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-indigo-50 p-6 rounded-2xl">
                            <h4 class="text-[10px] font-black text-indigo-900 uppercase mb-2 tracking-widest">Target
                                Audience</h4>
                            <p id="targetText" class="text-indigo-800 font-bold">[Pending]</p>
                        </div>
                        <div class="bg-amber-50 p-6 rounded-2xl">
                            <h4 class="text-[10px] font-black text-amber-900 uppercase mb-2 tracking-widest">Unique
                                Value</h4>
                            <p id="uvpText" class="text-amber-800 font-bold">[Pending]</p>
                        </div>
                        <div class="bg-rose-50 p-6 rounded-2xl">
                            <h4 class="text-[10px] font-black text-rose-900 uppercase mb-2 tracking-widest">Core Pain
                                Point</h4>
                            <p id="painPointText" class="text-rose-800 font-bold">[Pending]</p>
                        </div>
                    </div>

                    <h3 class="text-3xl font-black text-slate-900 my-6">Not A Priority</h3>
                    <div id="not_a_priority" class="text-slate-600 text-lg leading-relaxed mb-8 italic">[Generating...]
                    </div>
                </div>
            </div>

            <!-- TAB 2: Marketing Focus -->
            <div id="marketingTab" class="tab-content hidden">
                <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-3xl font-black text-slate-900 mb-6">Marketing Strategy</h3>
                    <div class="space-y-6">
                        <div class="p-6 bg-slate-50 rounded-2xl">
                            <h4 class="text-xs font-black text-slate-500 uppercase mb-1">Primary Goal</h4>
                            <p id="marketingGoal" class="text-xl font-bold text-slate-900">[Goal]</p>
                        </div>
                        <div class="p-6 bg-slate-50 rounded-2xl">
                            <h4 class="text-xs font-black text-slate-500 uppercase mb-1">Core Message</h4>
                            <p id="marketingMessage" class="text-lg text-slate-700">[Message]</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: Email Campaign -->
            <div id="emailsTab" class="tab-content hidden">
                <div id="emailsContainer" class="grid grid-cols-1 gap-6">
                    <div
                        class="p-8 bg-white rounded-3xl border-2 border-dashed border-slate-200 text-center text-slate-400">
                        Emails will appear here once generated...
                    </div>
                </div>
            </div>

            <!-- TAB 4: Action Plan -->
            <div id="tasksTab" class="tab-content hidden">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th
                                    class="px-8 py-5 text-left text-xs font-black text-slate-400 uppercase tracking-widest">
                                    Order</th>
                                <th
                                    class="px-8 py-5 text-left text-xs font-black text-slate-400 uppercase tracking-widest">
                                    Task Details</th>
                                <th
                                    class="px-8 py-5 text-left text-xs font-black text-slate-400 uppercase tracking-widest">
                                    Impact</th>
                            </tr>
                        </thead>
                        <tbody id="tasksBody" class="divide-y divide-slate-100 italic text-slate-400">
                            <tr>
                                <td colspan="3" class="px-8 py-10 text-center">No tasks generated yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

    </div>
    </div>

    <!-- APP LOGIC -->
    <script>
        const form = document.getElementById('agentForm');
        const logsContainer = document.getElementById('logsContainer');
        const resultsSection = document.getElementById('resultsSection');
        const runBtn = document.getElementById('runBtn');

        // 1. CLEAR MEMORY LOGIC
        document.getElementById('clearContextBtn').addEventListener('click', async () => {
            if (!confirm("Wipe Agent Memory?")) return;
            // -- YOU WILL WRITE THE FETCH('/reset-db') HERE --
            alert("Memory Wiped!");
        });

        // 2. TAB CONTROLLER
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-indigo-600', 'border-indigo-600');
                    b.classList.add('text-slate-400', 'border-transparent');
                });
                btn.classList.add('text-indigo-600', 'border-indigo-600');
                btn.classList.remove('border-transparent');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${btn.dataset.tab}Tab`).classList.remove('hidden');
            });
        });

        function addLog(step, message) {
            const line = document.createElement('div');
            line.className = "log-line text-xs mb-2";
            line.innerHTML = `<span class="text-white font-black uppercase mr-2">[${step}]</span> ${message}`;
            logsContainer.appendChild(line);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }


        // STREAM AGENT FUNCTION
           async function streamAgent(formData) {
            const response = await fetch('/run-agent', {
                method: 'POST',
                body: formData
            });

            if (!response.ok || !response.body) {
                throw new Error(`Streaming not supported or server error`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = ''

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true })
                const chunks = buffer.split('\n\n');
                buffer = chunks.pop() || ''; // Keep incomplete chunk

                for(const chunk of chunks) {
                    const clean = chunk.replace(/^data:\s*/, '').trim();
                    if(!clean) continue

                    try {
                        const event = JSON.parse(clean);

                        if (event.type === 'log') {
                            addLog(event.content.step, event.content.message);
                        } else if (event.type === 'result') {
                            renderData(event.content);
                        }
                    } catch (error) {
                        console.error("Error parsing chunk:", error);
                    }
                }
            }
           }

        // 3. MAIN AGENT EXECUTION
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // RESET
            runBtn.disabled = true;
            runBtn.innerText = "Consulting AI...";
            document.getElementById('logsSection').classList.remove('hidden');
            resultsSection.classList.add('hidden');
            logsContainer.innerHTML = '';

            addLog("SYSTEM", "Gathering parameters and context...");

            // --- WRITE CORE FETCH LOGIC HERE ---
            const formData = new FormData()
            formData.append('business_task', document.getElementById('taskInput').value);
            formData.append('tone', document.getElementById('toneInput').value);
            formData.append('depth', document.getElementById('depthInput').value);

            try {
                await streamAgent(formData)
            } catch (error) {
                addLog("Error: "+ error?.message)
            } finally {
                runBtn.disabled = false;
                runBtn.innerText = "Run Agent Analysis";
            }
        });
        // 4. RENDERING HELPERS (Keep these for easier teaching)
        function renderData(out) {
            // Strategy
            if (out.business_overview) {

                document.getElementById('summaryText').innerText = out.business_overview.summary;
                document.getElementById('targetText').innerText = out.business_overview.primary_target_audience;
                document.getElementById('uvpText').innerText = out.business_overview.unique_value_proposition;
                document.getElementById('painPointText').innerText = out.business_overview.core_pain_point;
                document.getElementById('not_a_priority').innerText = out.business_overview.not_a_priority;
            }

            // Marketing
            if (out.marketing_strategy) {

                document.getElementById('marketingGoal').innerText = out.marketing_strategy.primary_goal;
                document.getElementById('marketingMessage').innerText = out.marketing_strategy.core_message;
            }

            // Emails
                if (Array.isArray(out.email_campaign)) {
                
                    const emailsList = document.getElementById('emailsContainer');
                    emailsList.innerHTML = '';
                    out.email_campaign.forEach(em => {
                        const card = document.createElement('div');
                        card.className = "p-8 bg-white rounded-3xl border border-slate-100 shadow-sm";
                        card.innerHTML = `<h4 class="font-black text-indigo-900 mb-2">${em.subject}</h4><p class="text-slate-600 whitespace-pre-wrap">${em.body}</p>`;
                        emailsList.appendChild(card);
                    });
                }

            // Tasks
                if (Array.isArray(out.task_breakdown)) {
                
                    const tasksTable = document.getElementById('tasksBody');
                    tasksTable.innerHTML = '';
                    out.task_breakdown.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td class="px-8 py-6 font-mono text-slate-400 font-bold">#${t.task_order}</td><td class="px-8 py-6 font-bold text-slate-900">${t.task_name}</td><td class="px-8 py-6 text-indigo-500 italic">${t.why_this_matters}</td>`;
                        tasksTable.appendChild(tr);
                    });
                }

            resultsSection.classList.remove('hidden');
        }
    </script>
</body>

</html>